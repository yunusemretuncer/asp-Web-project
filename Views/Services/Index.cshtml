@model IEnumerable<AspWebProject.Models.Service>
@{
    ViewData["Title"] = "Hizmetler";
    bool isAdmin = User.IsInRole("Admin");
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Hizmetler</h2>

    @if (isAdmin)
    {
        <a class="btn btn-success" href="/Services/Create">
            <i class="bi bi-plus-circle"></i> Yeni Hizmet Ekle
        </a>
    }
</div>

<!-- === FİLTRE PANELİ AÇ/KAPA === -->
<button id="ToggleFilters" class="btn btn-secondary mb-3">
    Filtreleri Göster
</button>

<div id="FilterPanel" style="display:none;" class="border rounded p-3 mb-4 bg-light shadow-sm">
    <div class="row">
        <div class="col-md-4">
            <label class="fw-bold">Fitness Center</label>
            <select id="FitnessFilter" class="form-control">
                <option value="0">Hepsi</option>
                @foreach (var fc in ViewBag.FitnessCenters)
                {
                    <option value="@fc.Id">@fc.Name</option>
                }
            </select>
        </div>
    </div>

    <button id="FilterBtn" class="btn btn-success mt-3">
        <i class="bi bi-funnel"></i> Filtrele
    </button>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table table-hover mb-0" id="ServiceTable">
            <thead class="table-success">
                <tr>
                    <th>Hizmet</th>
                    <th>Süre</th>
                    <th>Ücret</th>
                    <th>Salon</th>
                    <th class="text-end">İşlem</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5">Veri bekleniyor...</td></tr>
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>

        $("#ToggleFilters").on("click", function () {
            $("#FilterPanel").toggle();
            $(this).text($("#FilterPanel").is(":visible")
                ? "Filtreleri Gizle"
                : "Filtreleri Göster");
        });

        function loadServices() {

            let fcId = $("#FitnessFilter").val();
            let isAdmin = @isAdmin.ToString().ToLower();

            $("#ServiceTable tbody").html("<tr><td colspan='5'>Yükleniyor...</td></tr>");

            $.get(`/api/ServicesApi/filter?fitnessCenterId=${fcId}`, function (list) {

                let html = "";

                if (list.length === 0) {
                    html = "<tr><td colspan='5'>Kayıt bulunamadı.</td></tr>";
                }
                else {
                    list.forEach(s => {
                        html += `
                            <tr>
                                <td>${s.name}</td>
                                <td>${s.duration} saat</td>
                                <td>${s.price} ₺</td>
                                <td>${s.fitnessCenter}</td>

                                <td class="text-end">
                                    ${isAdmin ? `
                                    <a href="/Services/Edit/${s.id}" class="btn btn-sm btn-outline-primary me-1">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </a>` : ""}

                                    <a href="/Services/Details/${s.id}" class="btn btn-sm btn-outline-info me-1">
                                        <i class="bi bi-info-circle"></i> Details
                                    </a>

                                    ${isAdmin ? `
                                    <a href="/Services/Delete/${s.id}" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i> Delete
                                    </a>` : ""}
                                </td>
                            </tr>`;
                    });
                }

                $("#ServiceTable tbody").html(html);
            });
        }

        $("#FilterBtn").click(loadServices);
        loadServices();
    </script>
}

@{
    ViewData["Title"] = "Randevular";
    bool isAdmin = User.IsInRole("Admin");
}

<h2 class="mb-4">Randevular</h2>
<a href="/Appointments/Create">Yeni Randevu Oluştur</a>
<!-- === FİLTRELERİ GÖSTER / GİZLE === -->
<button id="ToggleFilters" class="btn btn-secondary mb-3">
    Filtreleri Göster
</button>

<div id="FilterPanel" style="display:none;" class="border rounded p-3 mb-3 bg-light">

    <div class="row">

        <div class="col-md-3">
            <label>Başlangıç Tarihi</label>
            <input id="StartDate" type="date" class="form-control" />
        </div>

        <div class="col-md-3">
            <label>Hizmet</label>
            <select id="ServiceId" class="form-control">
                <option value="0">Hepsi</option>
                @foreach (var s in ViewBag.Services)
                {
                    <option value="@s.Id">@s.Name</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label>Eğitmen</label>
            <select id="TrainerId" class="form-control">
                <option value="0">Hepsi</option>
                @foreach (var t in ViewBag.Trainers)
                {
                    <option value="@t.Id">@t.FullName</option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label>Status</label>
            <select id="Status" class="form-control">
                <option value="">Hepsi</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
            </select>
        </div>

        @if (isAdmin)
        {
            <div class="col-md-3 mt-3">
                <label>Kullanıcı</label>
                <select id="UserId" class="form-control">
                    <option value="all">Hepsi</option>
                    @foreach (var u in ViewBag.Users)
                    {
                        <option value="@u.Id">@u.UserName</option>
                    }
                </select>
            </div>
        }

    </div>

    <button id="FilterBtn" class="btn btn-primary mt-3">Filtrele</button>
</div>


<!-- === TABS: GELECEK / GEÇMİŞ === -->
<ul class="nav nav-tabs mb-3" id="AppointmentTabs">
    <li class="nav-item">
        <a class="nav-link active" data-mode="future" href="#">Gelecek Randevular</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-mode="past" href="#">Geçmiş Randevular</a>
    </li>
</ul>


<table class="table table-bordered">
    <thead>
        <tr>
            <th>Tarih</th>
            <th>Hizmet</th>
            <th>Eğitmen</th>
            <th>Salon</th>

            @if (isAdmin)
            {
                <th>Kullanıcı</th>
            }

            <th>Status</th>
            <th>İşlem</th>
        </tr>
    </thead>
    <tbody id="tableBody">
        <tr><td colspan="7">Veri bekleniyor...</td></tr>
    </tbody>
</table>

@section Scripts {
    <script>

        const IsAdmin = @(isAdmin.ToString().ToLower());
        let currentMode = "future"; // gelecekle başlar

        // ---- STATUS Badge ----
        function getStatusBadge(status) {
            if (status === "Approved") return `<span class="badge bg-success">Approved</span>`;
            if (status === "Rejected") return `<span class="badge bg-danger">Rejected</span>`;
            return `<span class="badge bg-warning text-dark">Pending</span>`;
        }

        // ---- Verileri Getir ----
        function loadAppointments() {

            const query = {
                mode: currentMode,
                startDate: $("#StartDate").val(),
                serviceId: $("#ServiceId").val(),
                trainerId: $("#TrainerId").val(),
                status: $("#Status").val(),
                userId: IsAdmin ? $("#UserId").val() : null
                
            };

            $("#tableBody").html("<tr><td colspan='7'>Yükleniyor...</td></tr>");

            $.get("/api/AppointmentsApi/filter", query, function (data) {

                if (!data || data.length === 0) {
                    $("#tableBody").html("<tr><td colspan='7'>Kayıt bulunamadı.</td></tr>");
                    return;
                }

                let html = "";

                data.forEach(a => {

                    let adminUserCol = IsAdmin ? `<td>${a.user}</td>` : "";

                    let adminButtons = IsAdmin ? `
                        <a href="/Appointments/Edit/${a.id}" class="btn btn-sm btn-warning">Edit</a>
                        <a href="/Appointments/Delete/${a.id}" class="btn btn-sm btn-danger">Delete</a>

                        <form method="post" action="/Appointments/Approve/${a.id}" style="display:inline;">
                            <button class="btn btn-sm btn-success ms-1">Onayla</button>
                        </form>
                        <form method="post" action="/Appointments/Reject/${a.id}" style="display:inline;">
                            <button class="btn btn-sm btn-danger ms-1">Reddet</button>
                        </form>
                    ` : "";

                    html += `
                        <tr>
                            <td>${a.date}</td>
                            <td>${a.service}</td>
                            <td>${a.trainer}</td>
                            <td>${a.center}</td>
                            ${adminUserCol}
                            <td>${getStatusBadge(a.status)}</td>
                            <td>
                                <a href="/Appointments/Details/${a.id}" class="btn btn-sm btn-info">Detay</a>
                                ${adminButtons}
                            </td>
                        </tr>
                    `;
                });

                $("#tableBody").html(html);
            });
        }

        // ---- Filtre paneli aç/kapa ----
        $("#ToggleFilters").on("click", function () {
            $("#FilterPanel").toggle();
            $(this).text($("#FilterPanel").is(":visible") ? "Filtreleri Gizle" : "Filtreleri Göster");
        });

        // ---- Tab seçimleri ----
        $("#AppointmentTabs a").on("click", function (e) {
            e.preventDefault();

            $("#AppointmentTabs a").removeClass("active");
            $(this).addClass("active");

            currentMode = $(this).data("mode"); // "future" veya "past"
            loadAppointments();
        });

        $("#FilterBtn").on("click", loadAppointments);

        $(document).ready(loadAppointments);

    </script>
}









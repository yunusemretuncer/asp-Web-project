@{
    ViewData["Title"] = "Randevular";
    bool isAdmin = User.IsInRole("Admin");
}

<h2>Randevular</h2>

<div class="row mb-3">

    <a href="/Appointments/Create" class="btn btn-success mb-3">Yeni Randevu Oluştur</a>

    <div class="col-md-3">
        <label>Başlangıç Tarihi</label>
        <input id="StartDate" type="date" class="form-control" />
    </div>

    <div class="col-md-3">
        <label>Hizmet</label>
        <select id="ServiceId" class="form-control">
            <option value="0">Hepsi</option>
            @foreach (var s in ViewBag.Services)
            {
                <option value="@s.Id">@s.Name</option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label>Eğitmen</label>
        <select id="TrainerId" class="form-control">
            <option value="0">Hepsi</option>
            @foreach (var t in ViewBag.Trainers)
            {
                <option value="@t.Id">@t.FullName</option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label>Status</label>
        <select id="Status" class="form-control">
            <option value="">Hepsi</option>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
        </select>
    </div>

    @if (isAdmin)
    {
        <div class="col-md-3 mt-3">
            <label>Kullanıcı</label>
            <select id="UserId" class="form-control">
                <option value="all">Hepsi</option>
                @foreach (var u in ViewBag.Users)
                {
                    <option value="@u.Id">@u.UserName</option>
                }
            </select>
        </div>
    }
</div>

<button id="FilterBtn" class="btn btn-primary mb-3">Filtrele</button>


<table class="table table-bordered">
    <thead>
        <tr>
            <th>Tarih</th>
            <th>Hizmet</th>
            <th>Eğitmen</th>
            <th>Salon</th>

            @if (isAdmin)
            {
                <th>Kullanıcı</th>
            }

            <th>Status</th>
            <th>İşlem</th>
        </tr>
    </thead>
    <tbody id="tableBody">
        <tr><td colspan="7">Veri bekleniyor...</td></tr>
    </tbody>
</table>




@section Scripts {
    <script>

        const IsAdmin = @(isAdmin.ToString().ToLower());

        // ----------------- STATUS BADGE -----------------
        function getStatusBadge(status) {
            if (status === "Approved") return `<span class="badge bg-success">Approved</span>`;
            if (status === "Rejected") return `<span class="badge bg-danger">Rejected</span>`;
            return `<span class="badge bg-warning text-dark">Pending</span>`;
        }

        // ----------------- VERİ YÜKLE -------------------
        function loadAppointments() {

            const query = {
                startDate: $("#StartDate").val(),
                serviceId: $("#ServiceId").val(),
                trainerId: $("#TrainerId").val(),
                status: $("#Status").val(),
                userId: IsAdmin ? $("#UserId").val() : null
            };

            $("#tableBody").html("<tr><td colspan='7'>Yükleniyor...</td></tr>");

            $.get("/api/AppointmentsApi/filter", query, function (data) {

                if (!data || data.length === 0) {
                    $("#tableBody").html("<tr><td colspan='7'>Kayıt bulunamadı.</td></tr>");
                    return;
                }

                let html = "";

                data.forEach(a => {

                    let adminUserCol = IsAdmin ? `<td>${a.user}</td>` : "";

                    let adminButtons = IsAdmin ? `
                        <a href="/Appointments/Edit/${a.id}" class="btn btn-sm btn-warning">Edit</a>
                        <a href="/Appointments/Delete/${a.id}" class="btn btn-sm btn-danger">Delete</a>
                        <form method="post" action="/Appointments/Approve/${a.id}" style="display:inline;">
                            <button class="btn btn-sm btn-success ms-1">Onayla</button>
                        </form>
                        <form method="post" action="/Appointments/Reject/${a.id}" style="display:inline;">
                            <button class="btn btn-sm btn-danger ms-1">Reddet</button>
                        </form>
                    ` : "";

                    html += `
                        <tr>
                            <td>${a.date}</td>
                            <td>${a.service}</td>
                            <td>${a.trainer}</td>
                            <td>${a.center}</td>

                            ${adminUserCol}

                            <td>${getStatusBadge(a.status)}</td>

                            <td>
                                <a href="/Appointments/Details/${a.id}" class="btn btn-sm btn-info">Detay</a>
                                ${adminButtons}
                            </td>
                        </tr>
                    `;
                });

                $("#tableBody").html(html);
            });
        }


        $("#FilterBtn").on("click", loadAppointments);
        $(document).ready(loadAppointments);

    </script>
}








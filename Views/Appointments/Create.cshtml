@model Appointment

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="bi bi-calendar-plus"></i> Randevu Oluştur</h4>
        </div>

        <div class="card-body">

            <form asp-action="Create">

                <!-- FITNESS CENTER -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Fitness Center</label>
                    <select id="FitnessCenterId" name="FitnessCenterId"
                            class="form-select" asp-items="ViewBag.FitnessCenters">
                        <option value="">Seçiniz...</option>
                    </select>
                    <span asp-validation-for="FitnessCenterId" class="text-danger"></span>
                </div>

                <!-- SERVICE -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Hizmet (Service)</label>
                    <select id="ServiceId" name="ServiceId" class="form-select">
                        <option value="">Önce salon seçiniz...</option>
                    </select>
                    <span asp-validation-for="ServiceId" class="text-danger"></span>
                </div>

                <!-- TRAINER -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Eğitmen (Trainer)</label>
                    <select id="TrainerId" name="TrainerId" class="form-select">
                        <option value="">Önce hizmet seçiniz...</option>
                    </select>
                    <span asp-validation-for="TrainerId" class="text-danger"></span>
                </div>

                <!-- DATE -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Tarih</label>
                    <input id="AppointmentDate" type="date" name="Date"
                           class="form-control" required />
                    <span asp-validation-for="Date" class="text-danger"></span>
                </div>

                <!-- HOUR -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Saat</label>
                    <select id="HourDropdown" name="HourString"
                            class="form-select" required>
                        <option value="">Önce tarih seçiniz...</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-check-circle"></i> Randevuyu Kaydet
                </button>

            </form>

        </div>
    </div>
</div>

@section Scripts {
    <script>

        // ============ 1) Fitness Center → Service ============
        $("#FitnessCenterId").change(function () {
            const id = $(this).val();

            $("#ServiceId").html('<option>Yükleniyor...</option>');
            $("#TrainerId").html('<option>Önce hizmet seçiniz...</option>');
            $("#HourDropdown").html('<option>Önce tarih seçiniz...</option>');

            $.get(`/Services/GetByFitnessCenter?fitnessCenterId=${id}`, function (list) {
                let html = '<option value="">Hizmet seçiniz...</option>';
                list.forEach(s => html += `<option value="${s.id}">${s.name}</option>`);
                $("#ServiceId").html(html);
            });
        });

        // ============ 2) Service → Trainer ============
        $("#ServiceId").change(function () {
            const id = $(this).val();

            $("#TrainerId").html('<option>Yükleniyor...</option>');
            $("#HourDropdown").html('<option>Önce tarih seçiniz...</option>');

            $.get(`/Trainers/GetByService?serviceId=${id}`, function (list) {
                let html = '<option value="">Eğitmen seçiniz...</option>';
                list.forEach(t => html += `<option value="${t.id}">${t.fullName}</option>`);
                $("#TrainerId").html(html);
            });
        });

        // ============ 3) Date seçildi → Uygun saatleri getir ============
        $("#AppointmentDate").change(function () {

            const dateVal = $(this).val();
            const trainerId = $("#TrainerId").val();
            const serviceId = $("#ServiceId").val();

            if (!trainerId || !serviceId) {
                $("#HourDropdown").html('<option>Önce eğitmen seçiniz...</option>');
                return;
            }

            $.get(`/Appointments/GetAvailableHours?trainerId=${trainerId}&serviceId=${serviceId}&date=${dateVal}`,
                function (hours) {

                    let html = "";

                    if (hours.length === 0)
                        html = '<option>Müsait saat yok</option>';
                    else
                        hours.forEach(h => html += `<option value="${h}">${h}</option>`);

                    $("#HourDropdown").html(html);
                });
        });

    </script>
}

